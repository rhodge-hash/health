<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repo Health Dashboard</title>
    <!-- Use the Tailwind CSS CDN for a clean and modern look -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
        }
        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .status-icon {
            font-size: 1.5rem;
        }
        .status-success {
            color: #10b981; /* green-500 */
        }
        .status-failure {
            color: #ef4444; /* red-500 */
        }
        .status-pending {
            color: #f59e0b; /* amber-500 */
        }
        .progress-bar-transition {
            transition: width 0.5s ease-in-out;
        }
        .message-box {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            transform: translateY(-20px);
            opacity: 0;
        }
        .message-box.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-6 rounded-2xl card w-full max-w-4xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-2 text-gray-100">Repo Health Dashboard</h1>
        <p class="text-center text-gray-400 mb-8 flex flex-col sm:flex-row justify-center items-center gap-2">
            <span>Get a quick overview of your GitHub repository's status.</span>
            <span id="lastUpdated" class="text-xs text-gray-500"></span>
        </p>

        <!-- Input Section -->
        <div class="bg-gray-800 p-6 rounded-xl mb-8 flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
                <label for="repoInput" class="block text-sm font-medium text-gray-300 mb-1">GitHub Repo URL (e.g., owner/repo)</label>
                <input type="text" id="repoInput" placeholder="Enter repo name" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex-1">
                <label for="branchInput" class="block text-sm font-medium text-gray-300 mb-1">Branch Name</label>
                <input type="text" id="branchInput" value="main" placeholder="e.g., main" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex-1">
                <label for="tokenInput" class="block text-sm font-medium text-gray-300 mb-1">Personal Access Token (optional)</label>
                <input type="password" id="tokenInput" placeholder="Paste your token here" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="sm:self-end">
                <button id="fetchBtn" class="w-full sm:w-auto px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-colors duration-200">
                    Fetch Status
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-6 rounded-xl mb-8">
            <label for="requiredChecksInput" class="block text-sm font-medium text-gray-300 mb-1">Required Checks (comma-separated names)</label>
            <input type="text" id="requiredChecksInput" placeholder="e.g., Vercel, Build, Deploy" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        
        <!-- Status Display Section -->
        <div id="loading" class="text-center text-gray-400 my-8 hidden">
            <div class="flex justify-center items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading...
            </div>
        </div>

        <div id="messageBox" class="message-box fixed top-4 right-4 p-4 rounded-lg shadow-lg flex items-center space-x-2 z-50">
            <p id="messageText" class="text-sm font-medium"></p>
        </div>

        <div id="dashboard" class="space-y-6 hidden">
            <!-- Repo Info Card -->
            <div class="card p-6 rounded-xl">
                <h2 class="text-2xl font-semibold mb-2">Repository Details</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-400">Name:</p>
                        <p id="repoName" class="text-lg font-medium"></p>
                    </div>
                    <div>
                        <p class="text-gray-400">Branch:</p>
                        <p id="branchName" class="text-lg font-medium"></p>
                    </div>
                    <div>
                        <p class="text-gray-400">Latest Commit:</p>
                        <p id="latestCommit" class="text-lg font-medium"></p>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-gray-400">Overall Status:</p>
                    <p id="overallStatus" class="text-2xl font-bold mt-1 flex items-center gap-2"></p>
                    <div id="progressBarContainer" class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full progress-bar-transition" style="width: 0%;"></div>
                    </div>
                    <p id="progressText" class="text-sm text-gray-400 mt-1"></p>
                </div>
            </div>

            <!-- Checks and Actions Card -->
            <div class="card p-6 rounded-xl">
                <h2 class="text-2xl font-semibold mb-4 flex justify-between items-center">
                    <span>Checks & Actions</span>
                    <a id="viewAllLink" href="#" target="_blank" class="text-sm text-blue-400 hover:underline">View All on GitHub</a>
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-400 text-sm uppercase tracking-wide">
                                <th class="py-2 px-4">Status</th>
                                <th class="py-2 px-4">Name</th>
                                <th class="py-2 px-4">Time</th>
                                <th class="py-2 px-4">Link</th>
                            </tr>
                        </thead>
                        <tbody id="checksAndActionsBody">
                            <!-- Rows will be dynamically populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Instructions Section -->
        <div id="instructions" class="card p-6 rounded-xl mt-8">
            <h2 class="text-2xl font-semibold mb-4 text-center">Instructions</h2>
            <div class="space-y-4 text-gray-300">
                <p>1. **Save this file:** Save this code as <code>index.html</code>.</p>
                <p>2. **Create a GitHub Repo:** Initialize a new, empty repository on GitHub.</p>
                <p>3. **Push the file:** Add <code>index.html</code> to your new repo and push it to the <code>main</code> branch.</p>
                <p>4. **Enable GitHub Pages:** Go to your repo's "Settings" tab, then "Pages". Under "Source," select the <code>main</code> branch and click "Save". Your dashboard will be live in a few minutes at your GitHub Pages URL.</p>
                <p>5. **Generate a Personal Access Token (optional but recommended):**
                   <br>The GitHub API has strict rate limits for unauthenticated requests. For better performance and to view private repositories, you should generate a Personal Access Token.
                   <br> Go to <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-400 hover:underline">GitHub settings &gt; Developer settings &gt; Personal access tokens</a>.
                   <br> Click "Generate new token". Give it a descriptive name (e.g., "Dashboard Token") and select the <code>repo</code> scope. This token will only be visible once, so copy it somewhere safe.</p>
                <p>6. **Use the Dashboard:** Open your GitHub Pages URL, enter your repo name and token, and click "Fetch Status"!</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const repoInput = document.getElementById('repoInput');
            const branchInput = document.getElementById('branchInput');
            const tokenInput = document.getElementById('tokenInput');
            const requiredChecksInput = document.getElementById('requiredChecksInput');
            const fetchBtn = document.getElementById('fetchBtn');
            const dashboard = document.getElementById('dashboard');
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const instructionsDiv = document.getElementById('instructions');
            
            // Dashboard elements
            const repoNameEl = document.getElementById('repoName');
            const branchNameEl = document.getElementById('branchName');
            const latestCommitEl = document.getElementById('latestCommit');
            const overallStatusEl = document.getElementById('overallStatus');
            const checksAndActionsBody = document.getElementById('checksAndActionsBody');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const viewAllLink = document.getElementById('viewAllLink');
            const lastUpdatedEl = document.getElementById('lastUpdated');
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            let fetchIntervalId = null;

            // Load saved values from localStorage
            repoInput.value = localStorage.getItem('githubRepo') || 'rhodge-hash/health';
            branchInput.value = localStorage.getItem('githubBranch') || 'main';
            tokenInput.value = localStorage.getItem('githubToken') || '';
            requiredChecksInput.value = localStorage.getItem('githubRequiredChecks') || '';

            fetchBtn.addEventListener('click', () => {
                const repo = repoInput.value.trim();
                const branch = branchInput.value.trim();
                const token = tokenInput.value.trim();
                const requiredChecks = requiredChecksInput.value.trim().split(',').map(s => s.trim().toLowerCase()).filter(s => s);

                if (!repo || !branch) {
                    showMessage('Please enter a GitHub repository name and a branch name.', 'error');
                    return;
                }

                // Clear previous interval
                if (fetchIntervalId) {
                    clearInterval(fetchIntervalId);
                }

                // Save values to localStorage for persistence
                localStorage.setItem('githubRepo', repo);
                localStorage.setItem('githubBranch', branch);
                localStorage.setItem('githubToken', token);
                localStorage.setItem('githubRequiredChecks', requiredChecksInput.value.trim());
                
                // Start a new interval for periodic fetching
                fetchData(repo, branch, token, requiredChecks);
                fetchIntervalId = setInterval(() => {
                    fetchData(repo, branch, token, requiredChecks);
                }, 10000); // Refresh every 10 seconds
            });

            function showMessage(text, type = 'info') {
                messageText.textContent = text;
                messageBox.classList.remove('bg-red-900', 'text-red-300', 'bg-blue-900', 'text-blue-300');
                if (type === 'error') {
                    messageBox.classList.add('bg-red-900', 'text-red-300');
                } else {
                    messageBox.classList.add('bg-blue-900', 'text-blue-300');
                }
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, 3000);
            }


            async function fetchData(repo, branch, token, requiredChecks) {
                loading.classList.remove('hidden');
                dashboard.classList.add('hidden');
                instructionsDiv.classList.add('hidden');

                const headers = { 'Accept': 'application/vnd.github.v3+json' };
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                try {
                    // Fetch latest commit
                    const commitRes = await fetch(`https://api.github.com/repos/${repo}/commits/${branch}`, { headers });
                    if (!commitRes.ok) {
                        if (commitRes.status === 404) {
                            throw new Error(`Branch '${branch}' not found for this repository.`);
                        }
                        throw new Error('Failed to fetch commit.');
                    }
                    const commitData = await commitRes.json();
                    const latestCommitSha = commitData.sha;

                    // Fetch commit statuses
                    const statusesRes = await fetch(`https://api.github.com/repos/${repo}/commits/${latestCommitSha}/statuses`, { headers });
                    const statusesData = await statusesRes.json();
                    
                    // Fetch check runs for the latest commit
                    const checksRes = await fetch(`https://api.github.com/repos/${repo}/commits/${latestCommitSha}/check-runs`, { headers });
                    const checksData = await checksRes.json();
                    
                    // Fetch workflow runs for the latest commit
                    const workflowsRes = await fetch(`https://api.github.com/repos/${repo}/actions/runs?branch=${branch}&per_page=5`, { headers });
                    const workflowsData = await workflowsRes.json();

                    renderDashboard(repo, branch, latestCommitSha, statusesData, checksData, workflowsData, requiredChecks);
                    lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

                } catch (err) {
                    console.error('API Fetch Error:', err);
                    showMessage(`An error occurred: ${err.message}`, 'error');
                    dashboard.classList.add('hidden');
                } finally {
                    loading.classList.add('hidden');
                }
            }

            function renderDashboard(repo, branch, commitSha, statusesData, checksData, workflowsData, requiredChecks) {
                // Show dashboard and hide instructions
                dashboard.classList.remove('hidden');
                instructionsDiv.classList.add('hidden');

                repoNameEl.textContent = repo;
                branchNameEl.textContent = branch;
                latestCommitEl.textContent = commitSha ? commitSha.substring(0, 7) : 'N/A';
                viewAllLink.href = `https://github.com/${repo}/actions/runs?branch=${branch}`;
                
                // Combine and sort all data sources
                const allChecksAndActions = [
                    ...(statusesData || []).map(item => ({ ...item, type: 'status', time: item.created_at })),
                    ...(checksData.check_runs || []).map(item => ({ ...item, type: 'check_run', time: item.started_at })),
                    ...(workflowsData.workflow_runs || []).map(item => ({ ...item, type: 'workflow_run', time: item.created_at }))
                ].sort((a, b) => new Date(b.time) - new Date(a.time)); // Sort by time

                // Filter based on required checks
                const relevantChecks = requiredChecks.length > 0 ?
                    allChecksAndActions.filter(item => 
                        requiredChecks.some(name => (item.context || item.name || item.workflow_name || '').toLowerCase().includes(name))
                    ) : allChecksAndActions;

                let overallStatus = 'pending';
                let overallStatusText = 'Pending...';
                
                if (relevantChecks.length > 0) {
                    const latestRelevantCheck = relevantChecks[0];
                    const status = latestRelevantCheck.conclusion || latestRelevantCheck.status || latestRelevantCheck.state;
                    
                    if (status === 'success' || status === 'completed') {
                        overallStatus = 'success';
                        overallStatusText = 'All required checks passed';
                    } else if (status === 'failure' || status === 'cancelled' || status === 'stale' || status === 'error' || status === 'failure') {
                        overallStatus = 'failure';
                        overallStatusText = 'A required check failed';
                    } else {
                        overallStatus = 'pending';
                        overallStatusText = 'Pending checks...';
                    }
                } else {
                    overallStatus = 'pending';
                    overallStatusText = 'No required checks found';
                }

                overallStatusEl.className = `text-2xl font-bold mt-1 flex items-center gap-2 status-${overallStatus}`;
                overallStatusEl.innerHTML = getStatusIcon(overallStatus) + `<span>${overallStatusText}</span>`;

                // Update progress bar
                const totalChecks = requiredChecks.length;
                const passedChecks = relevantChecks.filter(item => 
                    requiredChecks.some(name => (item.context || item.name || item.workflow_name || '').toLowerCase().includes(name)) &&
                    (item.conclusion === 'success' || item.state === 'success' || (item.status === 'completed' && item.conclusion === 'success'))
                ).length;
                
                let progressPercentage = 0;
                if (totalChecks > 0) {
                    progressPercentage = (passedChecks / totalChecks) * 100;
                }
                
                progressBar.style.width = `${progressPercentage}%`;
                progressText.textContent = `${passedChecks}/${totalChecks} required checks passed`;


                // Render checks and actions table
                checksAndActionsBody.innerHTML = '';
                if (allChecksAndActions.length > 0) {
                    allChecksAndActions.forEach(item => {
                        const status = item.conclusion || item.status || item.state;
                        const statusClass = getStatusClass(status);
                        const statusIcon = getStatusIcon(status);
                        const name = item.context || item.name || item.workflow_name || 'N/A';
                        const time = new Date(item.time).toLocaleString();
                        // Prioritize html_url, then target_url, otherwise fall back to the main actions page
                        const link = item.html_url || item.target_url || `https://github.com/${repo}/actions/runs?branch=${branch}`;

                        const row = `
                            <tr class="hover:bg-gray-700 transition-colors duration-200">
                                <td class="py-3 px-4 flex items-center gap-2">
                                    <span class="${statusClass}">${statusIcon}</span>
                                </td>
                                <td class="py-3 px-4">${name}</td>
                                <td class="py-3 px-4 text-sm text-gray-400">${time}</td>
                                <td class="py-3 px-4">
                                    <a href="${link}" target="_blank" class="text-blue-400 hover:underline">View</a>
                                </td>
                            </tr>
                        `;
                        checksAndActionsBody.innerHTML += row;
                    });
                } else {
                    checksAndActionsBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-400">No recent checks or actions found for this branch.</td></tr>`;
                }
            }

            function getStatusClass(status) {
                const s = (status || '').toLowerCase();
                if (s === 'success' || s === 'completed') return 'status-success';
                if (s === 'failure' || s === 'cancelled' || s === 'stale' || s === 'error') return 'status-failure';
                return 'status-pending';
            }

            function getStatusIcon(status) {
                const s = (status || '').toLowerCase();
                if (s === 'success' || s === 'completed') return '✅';
                if (s === 'failure' || s === 'cancelled' || s === 'stale' || s === 'error') return '❌';
                return '⏳';
            }

            // Initial fetch if a repo is saved
            if (repoInput.value) {
                const requiredChecks = requiredChecksInput.value.trim().split(',').map(s => s.trim().toLowerCase()).filter(s => s);
                fetchData(repoInput.value, branchInput.value, tokenInput.value, requiredChecks);
                fetchIntervalId = setInterval(() => {
                    fetchData(repoInput.value, branchInput.value, tokenInput.value, requiredChecks);
                }, 10000); // Refresh every 10 seconds
            }
        });
    </script>
</body>
</html>
