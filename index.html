<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Repo Health Dashboard</title>
    <!-- Use the Tailwind CSS CDN for a clean and modern look -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
        }
        .card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .status-icon {
            font-size: 1.5rem;
        }
        .status-success {
            color: #10b981; /* green-500 */
        }
        .status-failure {
            color: #ef4444; /* red-500 */
        }
        .status-pending {
            color: #f59e0b; /* amber-500 */
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-6 rounded-2xl card w-full max-w-4xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-6 text-gray-100">Repo Health Dashboard</h1>
        <p class="text-center text-gray-400 mb-8">Get a quick overview of your GitHub repository's status.</p>

        <!-- Input Section -->
        <div class="bg-gray-800 p-6 rounded-xl mb-8 flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
                <label for="repoInput" class="block text-sm font-medium text-gray-300 mb-1">GitHub Repo URL (e.g., owner/repo)</label>
                <input type="text" id="repoInput" placeholder="Enter repo name" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex-1">
                <label for="branchInput" class="block text-sm font-medium text-gray-300 mb-1">Branch Name</label>
                <input type="text" id="branchInput" value="main" placeholder="e.g., main" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex-1">
                <label for="tokenInput" class="block text-sm font-medium text-gray-300 mb-1">Personal Access Token (optional)</label>
                <input type="password" id="tokenInput" placeholder="Paste your token here" class="w-full p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="sm:self-end">
                <button id="fetchBtn" class="w-full sm:w-auto px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-colors duration-200">
                    Fetch Status
                </button>
            </div>
        </div>
        
        <!-- Status Display Section -->
        <div id="loading" class="text-center text-gray-400 my-8 hidden">
            <div class="flex justify-center items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading...
            </div>
        </div>

        <div id="error" class="bg-red-900 p-4 rounded-lg my-8 text-center text-red-300 hidden">
            <p>An error occurred. Please check the repo name and your personal access token.</p>
        </div>

        <div id="dashboard" class="space-y-6 hidden">
            <!-- Repo Info Card -->
            <div class="card p-6 rounded-xl">
                <h2 class="text-2xl font-semibold mb-2">Repository Details</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-gray-400">Name:</p>
                        <p id="repoName" class="text-lg font-medium"></p>
                    </div>
                    <div>
                        <p class="text-gray-400">Branch:</p>
                        <p id="branchName" class="text-lg font-medium"></p>
                    </div>
                    <div>
                        <p class="text-gray-400">Latest Commit:</p>
                        <p id="latestCommit" class="text-lg font-medium"></p>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-gray-400">Overall Status:</p>
                    <p id="overallStatus" class="text-2xl font-bold mt-1 flex items-center gap-2"></p>
                </div>
            </div>

            <!-- Checks and Actions Card -->
            <div class="card p-6 rounded-xl">
                <h2 class="text-2xl font-semibold mb-4">Checks & Actions</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="text-gray-400 text-sm uppercase tracking-wide">
                                <th class="py-2 px-4">Status</th>
                                <th class="py-2 px-4">Name</th>
                                <th class="py-2 px-4">Time</th>
                                <th class="py-2 px-4">Link</th>
                            </tr>
                        </thead>
                        <tbody id="checksAndActionsBody">
                            <!-- Rows will be dynamically populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Instructions Section -->
        <div id="instructions" class="card p-6 rounded-xl mt-8">
            <h2 class="text-2xl font-semibold mb-4 text-center">Instructions</h2>
            <div class="space-y-4 text-gray-300">
                <p>1. **Save this file:** Save this code as <code>index.html</code>.</p>
                <p>2. **Create a GitHub Repo:** Initialize a new, empty repository on GitHub.</p>
                <p>3. **Push the file:** Add <code>index.html</code> to your new repo and push it to the <code>main</code> branch.</p>
                <p>4. **Enable GitHub Pages:** Go to your repo's "Settings" tab, then "Pages". Under "Source," select the <code>main</code> branch and click "Save". Your dashboard will be live in a few minutes at your GitHub Pages URL.</p>
                <p>5. **Generate a Personal Access Token (optional but recommended):**
                   <br>The GitHub API has strict rate limits for unauthenticated requests. For better performance and to view private repositories, you should generate a Personal Access Token.
                   <br> Go to <a href="https://github.com/settings/tokens" target="_blank" class="text-blue-400 hover:underline">GitHub settings &gt; Developer settings &gt; Personal access tokens</a>.
                   <br> Click "Generate new token". Give it a descriptive name (e.g., "Dashboard Token") and select the <code>repo</code> scope. This token will only be visible once, so copy it somewhere safe.</p>
                <p>6. **Use the Dashboard:** Open your GitHub Pages URL, enter your repo name and token, and click "Fetch Status"!</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const repoInput = document.getElementById('repoInput');
            const branchInput = document.getElementById('branchInput');
            const tokenInput = document.getElementById('tokenInput');
            const fetchBtn = document.getElementById('fetchBtn');
            const dashboard = document.getElementById('dashboard');
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const instructionsDiv = document.getElementById('instructions');
            
            // Dashboard elements
            const repoNameEl = document.getElementById('repoName');
            const branchNameEl = document.getElementById('branchName');
            const latestCommitEl = document.getElementById('latestCommit');
            const overallStatusEl = document.getElementById('overallStatus');
            const checksAndActionsBody = document.getElementById('checksAndActionsBody');

            // Load saved values from localStorage
            repoInput.value = localStorage.getItem('githubRepo') || '';
            branchInput.value = localStorage.getItem('githubBranch') || 'main';
            tokenInput.value = localStorage.getItem('githubToken') || '';

            fetchBtn.addEventListener('click', () => {
                const repo = repoInput.value.trim();
                const branch = branchInput.value.trim();
                const token = tokenInput.value.trim();

                if (!repo || !branch) {
                    alert('Please enter a GitHub repository name and a branch name.');
                    return;
                }

                // Save values to localStorage for persistence
                localStorage.setItem('githubRepo', repo);
                localStorage.setItem('githubBranch', branch);
                localStorage.setItem('githubToken', token);
                
                fetchData(repo, branch, token);
            });

            async function fetchData(repo, branch, token) {
                loading.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                dashboard.classList.add('hidden');
                instructionsDiv.classList.add('hidden');

                const headers = { 'Accept': 'application/vnd.github.v3+json' };
                if (token) {
                    headers['Authorization'] = `token ${token}`;
                }

                try {
                    // Fetch latest commit
                    const commitRes = await fetch(`https://api.github.com/repos/${repo}/commits/${branch}`, { headers });
                    if (!commitRes.ok) {
                        if (commitRes.status === 404) {
                            throw new Error(`Branch '${branch}' not found for this repository.`);
                        }
                        throw new Error('Failed to fetch commit.');
                    }
                    const commitData = await commitRes.json();
                    const latestCommitSha = commitData.sha;

                    // Fetch commit statuses
                    const statusesRes = await fetch(`https://api.github.com/repos/${repo}/commits/${latestCommitSha}/statuses`, { headers });
                    const statusesData = await statusesRes.json();
                    
                    // Fetch check runs for the latest commit
                    const checksRes = await fetch(`https://api.github.com/repos/${repo}/commits/${latestCommitSha}/check-runs`, { headers });
                    const checksData = await checksRes.json();
                    
                    // Fetch workflow runs for the latest commit
                    const workflowsRes = await fetch(`https://api.github.com/repos/${repo}/actions/runs?branch=${branch}&per_page=5`, { headers });
                    const workflowsData = await workflowsRes.json();

                    renderDashboard(repo, branch, latestCommitSha, statusesData, checksData, workflowsData);

                } catch (err) {
                    console.error('API Fetch Error:', err);
                    errorDiv.querySelector('p').textContent = `An error occurred: ${err.message}`;
                    errorDiv.classList.remove('hidden');
                    dashboard.classList.add('hidden');
                } finally {
                    loading.classList.add('hidden');
                }
            }

            function renderDashboard(repo, branch, commitSha, statusesData, checksData, workflowsData) {
                // Show dashboard and hide instructions
                dashboard.classList.remove('hidden');
                instructionsDiv.classList.add('hidden');

                repoNameEl.textContent = repo;
                branchNameEl.textContent = branch;
                latestCommitEl.textContent = commitSha ? commitSha.substring(0, 7) : 'N/A';
                
                let overallStatus = 'pending';
                let overallStatusText = 'Pending...';
                
                // Combine and sort all data sources
                const allChecksAndActions = [
                    ...(statusesData || []).map(item => ({ ...item, type: 'status' })),
                    ...(checksData.check_runs || []).map(item => ({ ...item, type: 'check_run' })),
                    ...(workflowsData.workflow_runs || []).map(item => ({ ...item, type: 'workflow_run' }))
                ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); // Sort by time

                // Determine overall status
                const hasFailed = allChecksAndActions.some(item => 
                    (item.conclusion === 'failure' || item.conclusion === 'cancelled' || item.conclusion === 'stale' || item.state === 'error' || item.state === 'failure') ||
                    (item.status === 'completed' && item.conclusion !== 'success')
                );
                const hasPending = allChecksAndActions.some(item => item.status !== 'completed' || item.state === 'pending' || item.state === 'in_progress');
                const hasSucceeded = allChecksAndActions.some(item => item.conclusion === 'success' || item.state === 'success');
                
                if (hasFailed) {
                    overallStatus = 'failure';
                    overallStatusText = 'Some checks failed';
                } else if (hasPending) {
                    overallStatus = 'pending';
                    overallStatusText = 'Pending checks...';
                } else if (hasSucceeded) {
                    overallStatus = 'success';
                    overallStatusText = 'All checks passed';
                }

                overallStatusEl.className = `text-2xl font-bold mt-1 flex items-center gap-2 status-${overallStatus}`;
                overallStatusEl.innerHTML = getStatusIcon(overallStatus) + `<span>${overallStatusText}</span>`;

                // Render checks and actions table
                checksAndActionsBody.innerHTML = '';
                if (allChecksAndActions.length > 0) {
                    allChecksAndActions.forEach(item => {
                        const status = item.conclusion || item.status || item.state;
                        const statusClass = getStatusClass(status);
                        const statusIcon = getStatusIcon(status);
                        const name = item.context || item.name || item.workflow_name || 'N/A';
                        const time = new Date(item.created_at).toLocaleString();
                        const link = item.html_url || item.target_url;

                        const row = `
                            <tr class="hover:bg-gray-700 transition-colors duration-200">
                                <td class="py-3 px-4 flex items-center gap-2">
                                    <span class="${statusClass}">${statusIcon}</span>
                                </td>
                                <td class="py-3 px-4">${name}</td>
                                <td class="py-3 px-4 text-sm text-gray-400">${time}</td>
                                <td class="py-3 px-4">
                                    <a href="${link}" target="_blank" class="text-blue-400 hover:underline">View</a>
                                </td>
                            </tr>
                        `;
                        checksAndActionsBody.innerHTML += row;
                    });
                } else {
                    checksAndActionsBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-400">No recent checks or actions found for this branch.</td></tr>`;
                }
            }

            function getStatusClass(status) {
                if (status === 'success' || status === 'completed') return 'status-success';
                if (status === 'failure' || status === 'cancelled' || status === 'stale' || status === 'error' || status === 'failure') return 'status-failure';
                return 'status-pending';
            }

            function getStatusIcon(status) {
                if (status === 'success' || status === 'completed') return '✅';
                if (status === 'failure' || status === 'cancelled' || status === 'stale' || status === 'error' || status === 'failure') return '❌';
                return '⏳';
            }

            // Initial fetch if a repo is saved
            if (repoInput.value) {
                fetchData(repoInput.value, branchInput.value, tokenInput.value);
            }
        });
    </script>
</body>
</html>
